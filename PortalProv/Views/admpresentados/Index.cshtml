@model  Wareways.PortalProv.Models.PP.PresentadosModelOficina
@using System.Configuration;
@{
    var Subsite = ConfigurationManager.AppSettings["SubSite"];
}

<!DOCTYPE html>


<div>
    <div class="box box-primary box-solid">
        <div class="box-header with-border">
            <h4 class="box-title"> <span class="fa fa-inbox fa-2x"></span>&nbsp;  Documentos Presentados (ADM)</h4>
            <div class="box-tools pull-right">

            </div>
        </div>
        <div class="box-body">
            <div class="col-md-12">
                <div class="btn-group pull-right">
                    @foreach (var _Item in Model.L_Estados)
                    {
                        if (_Item.Doc_Estado == "Rechazado")
                        {
                            @Html.ActionLink(_Item.Doc_Estado, "Index", new { FiltroEstado = _Item.Doc_Estado }, new { @class = (ViewBag.FiltroEstado != _Item.Doc_Estado) ? "btn btn-default btn-sm " : "btn btn-sm btn-primary " })
                        }
                        else
                        {
                            @Html.ActionLink(_Item.Doc_Estado + " ( " + _Item.Cantidad.ToString() + " )", "Index", new { FiltroEstado = _Item.Doc_Estado }, new { @class = (ViewBag.FiltroEstado != _Item.Doc_Estado) ? "btn btn-default btn-sm " : "btn btn-sm btn-primary " })
                        }

                    }
                </div>
            </div>

            @using (@Html.BeginForm("CreaContrasena", "admcontrasena", FormMethod.Post, new { @id = "multiformsub" }))
            {

                if (ViewBag.FiltroEstado == "Contraseña" && (Boolean)ViewBag.MostrarRedireccion)
                {
                    <div class="col-md-12 " style="text-align:right">
                        <br />
                        @Html.Label("Opciones:") &nbsp;
                        <button class="btn btn-warning " type="submit" name="CargarDocumentos" value="CargarDocumentos">
                            Crear Contraseñas &nbsp;
                            <i class="fa fa-plus-circle"></i>
                        </button>
                        <br />
                        <br />
                    </div>
                }

                // Boton
                {

                    if (Model.Nuevo_Estado_Seleccionado == "Aut. Contraseña" && User.IsInRole("Aut. Contraseña")) //&& User.IsInRole("Aut. Contrseña"))
                    {
                        <br /> <br />


                        <a href="#" class="btn btn-info btn-sm pull-right envIngresoSap"> Enviar Ingreso SAP &nbsp; <i class="glyphicon glyphicon-arrow-right"></i></a>
                        <span class="pull-right">&nbsp;&nbsp;&nbsp;</span>
                        <a href="#" class="btn btn-success btn-sm pull-right envReten"> Enviar Retenciones &nbsp; <i class="glyphicon glyphicon-arrow-right"></i></a>
                        <span class="pull-right">&nbsp;&nbsp;&nbsp;</span>
                        <a href="#" class="btn btn-warning btn-sm pull-right rechContrase"> <i class="glyphicon glyphicon-circle-arrow-left"></i>  &nbsp; Rechazar Contraseña </a>
                        <br /> <br />
                    }

                    if (Model.Nuevo_Estado_Seleccionado == "Ingreso SAP" && User.IsInRole("Generar Factura"))
                    {
                        <br /> <br />
                        <a href="#" class="btn btn-success btn-sm pull-right envFactAut"> Enviar Autorizacion &nbsp; <i class="glyphicon glyphicon-arrow-right"></i></a>
                        <br /> <br />
                    }
                    if (Model.Nuevo_Estado_Seleccionado == "Por Autorizar" && User.IsInRole("Aut Factura"))
                    {
                        <br /> <br />

                        <a href="#" class="btn btn-success btn-sm pull-right envRegistrada"> Enviar Registrada &nbsp; <i class="glyphicon glyphicon-circle-arrow-right"></i></a>
                        <span class="pull-right">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <a href="#" class="btn btn-warning btn-sm pull-right rechIngSap "> <i class="glyphicon glyphicon-circle-arrow-left"></i>  &nbsp; Rechazar Ingreso </a>
                        <br /> <br />
                    }

                }
                <br />
                <br />
                <br />
                <br />

                <table class="table table-bordered table-condensed table-hover Datos" style="width:1800px !important">
                    <thead>
                        <tr>
                            <th>Tipo OC</th>
                            <th></th>
                            <th></th>
                            <th>Tipo</th>
                            <th>Proveedor</th>
                            <th>Serie - Numero </th>

                            <th>Fecha Emision<br />/Carga</th>


                            <th>Monto</th>
                            <th>Cargado el</th>
                            <th>Orden Compra</th>
                            <th>Entrega</th>
                            <th>SAP</th>
                            <th>Usuario <br />Contraseña</th>
                            <th>Retencion</th>
                            <th>Observacion</th>
                            <th>Contraseña</th>
                            <th>Archivos</th>
                            <th>Mensajes</th>
                        </tr>
                    </thead>
                    <tbody>

                        @foreach (var item in Model.L_Documentos)
                        {
                            <tr>
                                <td>
                                    @if (item.Doc_ActivoFijo == true)
                                    {
                                        @:2 | Activo Fijo
                                    }
                                    else
                                    {
                                        if (item.Doc_OC_TipoDoc == "" || item.Doc_OC_TipoDoc == "Externo")
                                        {
                                            @:4 | AKIOL o Externo
                                        }
                                        if (item.Doc_OC_TipoDoc == "Servicio")
                                        {
                                            @:1 | Servicio
                                        }
                                        if (item.Doc_OC_TipoDoc == "Bien")
                                        {
                                            @:2 | Bien
                                        }
                                    }

                                </td>
                                <td>
                                    @if ((ViewBag.FiltroEstado != "Pagado"
                                            //&& ViewBag.FiltroEstado != "Ingreso SAP" && ViewBag.FiltroEstado != "Por Autorizar"
                                            )
                                            && (Boolean)ViewBag.MostrarRedireccion)
                                    {
                                        <a href="#" class="btn btn-sm btn-warning BtnOpenModalCambioEstado " data-id="@item.Doc_Id"> <span class="fa fa-share "></span>  </a>

                                    }

                                </td>
                                <td>
                                    @if (ViewBag.FiltroEstado == "Retenciones")
                                    {
                                        <a href="@Url.Action("Nuevo","admretenciones",new { Doc_id = item.Doc_Id } )" class="btn btn-sm btn-primary BtnOpenModalAgregaRetencion " title="Agregar Retenciones"> <span class="fa fa-plus-square-o "></span>  </a>
                                    }
                                    @if (ViewBag.FiltroEstado == "Contraseña" && item.Contrasena_Numero == null)
                                    {
                                        @Html.CheckBox("Selec_Item") @Html.Hidden("Selec_Code", item.Doc_Id) @Html.Hidden("Selec_Prov", item.Doc_CardCorde) @Html.Hidden("Selec_Empresa", item.Doc_EmpresaId)
                                    }
                                    @if (ViewBag.FiltroEstado == "Aut. Contraseña" && item.Contrasena_Numero != null)
                                    {
                                        @Html.CheckBox("Selec_Item") @Html.Hidden("Selec_Code", item.Doc_Id) @Html.Hidden("Selec_Prov", item.Doc_CardCorde) @Html.Hidden("Selec_Empresa", item.Doc_EmpresaId)
                                    }

                                    @if (ViewBag.FiltroEstado == "Ingreso SAP" || ViewBag.FiltroEstado == "Por Autorizar")
                                    {
                                        @Html.CheckBox("Selec_Item") @Html.Hidden("Selec_Code", item.Doc_Id) @Html.Hidden("Selec_Prov", item.Doc_CardCorde) @Html.Hidden("Selec_Empresa", item.Doc_EmpresaId)
                                    }



                                </td>


                                <td>@item.Doc_TipoDocumento</td>
                                <td>@item.Doc_CardCorde<br /> @item.CardName</td>

                                <td>
                                    <a href="@Url.Action("Detalle", new { id = item.Doc_Id })">
                                        @item.Doc_Serie - @item.Doc_Numero
                                    </a>
                                </td>



                                <td>
                                    @item.Doc_Fecha.Value.ToString("yyyy-MM-dd")<br />
                                    <small class="label bg-yellow">Cargado: @item.Doc_FechaCarga.Value.ToString("yyyy-MM-dd")</small>

                                </td>





                                <td>@item.Doc_MontoNeto.ToString("#,###,##0.00") @item.Doc_Moneda</td>

                                <td>@item.Doc_FechaCarga.Value.ToString("yyyy-MM-dd HH:mm")</td>

                                <td>
                                    @item.Doc_OC_Multiple
                                </td>

                                <td>
                                    <span title="Monto: @item.Doc_EM_MontoSum">
                                        <a href="#" data-toggle="modal" data-titulo="Entrega" data-nombre="@Url.Action("PrintEM.aspx","Reportes",new { pid = item.Doc_EM_Multiple })" data-target="#myModal" target="_blank" class="btn btn-default " title="Entrega"><span class="fa fa-file-pdf-o" style="color:orange"></span></a>
                                        @item.Doc_EM_Multiple

                                    </span>
                                </td>
                                <td><a href="" data-toggle="modal" data-titulo="Factura SAP" data-nombre="@Subsite/Reportes/PrintFactp.aspx?pid=@item.Doc_NumeroFactProv" data-target="#myModal" target="_blank" class="btn btn-default btn-sm " title="Factura SAP">@item.Doc_NumeroFactProv</a>  </td>
                                <td>@item.Contrasena_Usuario</td>
                                <td>@String.Format("{0:n2}", item.RetencionMonto)</td>

                                <td>@item.Doc_Observaciones</td>
                                <td>
                                    @if (item.Contrasena_Numero != null)
                                    {
                                        <a href="#" data-toggle="modal" data-titulo="Contraseña" data-nombre="@item.Contrasena_Id" data-target="#myModal" target="_blank" class="btn btn-default " title="Contraseña">@item.Contrasena_Numero</a>
                                    }


                                </td>
                                <td>
                                    @if (ViewBag.FiltroEstado == "Registrada" || ViewBag.FiltroEstado == "Pendiente" || ViewBag.FiltroEstado == "Pagado")
                                    {
                                        <a href="@Url.Action("Integrado.aspx", "Reportes", new { pid = item.Doc_Id.ToString() })" title="Intregrado" target="_blank" class="btn btn-default "><span class="fa fa-file-pdf-o" style="color:goldenrod"></span></a>

                                    }
                                    else
                                    {
                                        <a href="#" data-toggle="modal" data-titulo="Factura Cargada" data-nombre="@Subsite@item.Doc_PdfFactura" data-target="#myModal" target="_blank" class="btn btn-default " title="Factura"><span class="fa fa-file-pdf-o" style="color:red"></span></a>
                                        @:|
                                        <a href="#" data-toggle="modal" data-titulo="Orden Compra Cargada" data-nombre="@Subsite@item.Doc_PdfOC" data-target="#myModal" target="_blank" class="btn btn-default " title="Orden de Compra"><span class="fa fa-file-text-o" style="color:purple"></span></a>
                                    }

                                    <br />
                                    @{
                                        Html.RenderAction("LinksRetencionesDocto", new { id = item.Doc_Id });
                                    }

                                </td>
                                <td>
                                    @if (item.Msj_NoLeidos > 0)
                                    {
                                        <a href="#" class="btn btn-danger BtnOpenModalMensajes" title="OC" data-id="@item.Doc_Id"><span class="fa  fa-envelope-o "></span> &nbsp; <span class="badge bg-black"> @item.Msj_NoLeidos / @item.Msj_Total </span> </a>
                                    }
                                    else
                                    {
                                        <a href="#" class="btn btn-default BtnOpenModalMensajes" title="OC" data-id="@item.Doc_Id"><span class="fa fa-envelope-open "></span> &nbsp; <span class="badge bg-yellow"> @item.Msj_Total </span> </a>
                                    }


                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

    </div>
</div>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document" style="width:80%;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabelTitle">Modal title</h4>
            </div>

            <div class="modal-body" id="ContenedorPDF">

            </div>


        </div>
    </div>
</div>

@using (Html.BeginForm("CambioEstado", "admpresentados", FormMethod.Post, new { @class = "formsubmitgroup" }))
{
    @Html.AntiForgeryToken()

    @Html.Hidden("CambioEstado_Documento_Id")
    <div class="modal fade" id="ModalCambioEstado" role="dialog">
        <div class="modal-dialog err-pop" style="">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="col-md-11">
                        <h4 class="box-title"> Cambiar Estado </h4>
                    </div>
                    <div>
                        <button id="DivClose" type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                </div>
                <div class="modal-body" style="text-align:center;">
                    <div class="form-horizontal">

                        <div class="form-group">
                            @Html.Label("Enviar a", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.DropDownListFor(p => p.Nuevo_Estado_Seleccionado,
                                        Model.Nuevo_Estados_Asignar,
                                     new { @Class = "form-control ExcluirSoloLectura" })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.Label("Comentario", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.EditorFor(p => p.Nuevo_Estado_Comentario, new { htmlAttributes = new { @class = "form-control ExcluirSoloLectura" } })
                            </div>
                        </div>
                        <br />
                        <br />
                        <div class="pull-right">


                            <button class="btn btn-success pull-right " type="submit" id="saveTeststeps">
                                Grabar &nbsp;
                                <i class="fa fa-save"></i>
                            </button>
                        </div>
                    </div>
                    <br />
                    <br />
                </div>
            </div>
        </div>
    </div>

}

<div class="modal fade" id="ModalMostrarMensajes" role="dialog">
    <div class="modal-dialog err-pop modal-lg" style="">
        <div class="modal-content">
            <div class="modal-header">
                <div class="col-md-11">
                    <h4 class="box-title"> Mensajes Documento </h4>
                </div>
                <div>
                    <button id="DivClose" type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

            </div>
            <div class="modal-body" style="text-align:center;" id="ContenedorMensajes">

                <br />
                <br />
            </div>
        </div>
    </div>
</div>

<link href="~/admin-lte/bower_components/datatablesNew.net/datatables.css" rel="stylesheet" />

@section scripts
{
    <script src="~/admin-lte/bower_components/datatablesNew.net/datatables.min.js"></script>
    @*<script src="~/admin-lte/bower_components/datatables.net/js/jquery.dataTables.min.js"></script>
        <script src="~/admin-lte/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>*@
    <script src="~/admin-lte/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            $("#myModal").on("show.bs.modal", function (e) {
                var id = $(e.relatedTarget).data('nombre');
                var titulo = $(e.relatedTarget).data('titulo');

                if (titulo == "Contraseña") {
                    $("#ContenedorPDF").html("<embed src='@Subsite/Reportes/Contrasenas.aspx?id=" + id + "' type='application/pdf' style='width:100%; height:35vw;'  />");
                } else {
                    $("#ContenedorPDF").html("<embed src='" + id + "' type='application/pdf' style='width:100%; height:35vw;'  />");
                }



                $("#myModalLabelTitle").html(titulo);

            });
        });

        $(".BtnOpenModalCambioEstado").click(function () {
            var _id = this.getAttribute("data-id");
            $('#ModalCambioEstado').modal('show');
            $("#CambioEstado_Documento_Id").val(_id);
        })

        $(".BtnOpenModalMensajes").click(function () {

            var _id = this.getAttribute("data-id");

            $.ajax({
                url: "@Subsite/presentados/ObtenerMensajes/" + _id,
                cache: false,
                type: "GET",
                success: function (data) {
                    $("#ContenedorMensajes").html(data);


                },
                error: function (reponse) {
                    alert("error : " + reponse);
                }
            });
            $('#ModalMostrarMensajes').modal('show');

        })

        $(function () {
            $('.Datos').DataTable({
                'paging': true,
                'searching': true,
                'ordering': true,
                'autoWidth': false,
                'showinfo': false,
                "pageLength": 15,
                "scrollX": true,
                "order": [[0, "asc"], [6, "desc"]],
                "columnDefs": [
                    {
                        target: 0,
                        visible: false
                    }
                ],
                //"columnDefs": [
                //    { "width": "60%", "targets": 0 },
                //    { "width": "20%", "targets": 1 },
                //    { "width": "20%", "targets": 2 }
                //],
                "language": { "url": "https://cdn.datatables.net/plug-ins/2.3.2/i18n/es-ES.json" },
                "rowGroup": {
                    dataSrc: 0
                },
            })
        })

    </script>
    <script>
        $(".envFactAut").click(function () {
            document.getElementById("multiformsub").action = "@Url.Action("ms_envFactAut")";
            document.getElementById("multiformsub").submit();
            document.getElementById("multiformsub").action = "/admcontrasena/CreaContrasena";
        });
          $(".envRegistrada").click(function () {
            document.getElementById("multiformsub").action = "@Url.Action("ms_envRegisFact")";
            document.getElementById("multiformsub").submit();
            document.getElementById("multiformsub").action = "/admcontrasena/CreaContrasena";
          });
         $(".rechIngSap").click(function () {
            document.getElementById("multiformsub").action = "@Url.Action("ms_rechIngSap")";
            document.getElementById("multiformsub").submit();
            document.getElementById("multiformsub").action = "/admcontrasena/CreaContrasena";
         });

          $(".envIngresoSap").click(function () {
            document.getElementById("multiformsub").action = "@Url.Action("ms_envIngSAP")";
            document.getElementById("multiformsub").submit();
            document.getElementById("multiformsub").action = "/admcontrasena/CreaContrasena";
          });
        $(".envReten").click(function () {
            document.getElementById("multiformsub").action = "@Url.Action("ms_envRetenciones")";
            document.getElementById("multiformsub").submit();
            document.getElementById("multiformsub").action = "/admcontrasena/CreaContrasena";
        });
        $(".rechContrase").click(function () {
            document.getElementById("multiformsub").action = "@Url.Action("ms_rechContras")";
            document.getElementById("multiformsub").submit();
            document.getElementById("multiformsub").action = "/admcontrasena/CreaContrasena";
        });

    </script>

}